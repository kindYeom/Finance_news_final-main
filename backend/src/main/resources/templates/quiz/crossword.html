<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê°€ë¡œì„¸ë¡œ ë‚±ë§ í€´ì¦ˆ</title>
    <link rel="stylesheet" href="/css/quiz.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.userId = /*[[${userId}]]*/ 0;
        window.userNickname = /*[['${userNickname}']]*/ '';
        /*]]>*/
    </script>
</head>
<body style="margin: 0; font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f5;">
<div style="display: flex; height: 100vh; flex-direction: column;">

    <!-- ìƒë‹¨: ì „ì²´ ì œì¶œ ë²„íŠ¼ -->
    <div style="padding: 20px 40px; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1600px; margin: 0 auto;">
            <h1 style="margin: 0; font-size: 28px; color: #333;">ğŸ§© ê°€ë¡œì„¸ë¡œ ë‚±ë§ í€´ì¦ˆ</h1>
            <div style="display: flex; gap: 12px;">
                <button id="submitAllBtn" style="padding: 12px 24px; background-color: #4a90e2; color: white; border: none; border-radius: 12px; 
                        font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(74,144,226,0.3);">
                    ì „ì²´ ì œì¶œ
                </button>
                <button id="showAnswersBtn" style="padding: 12px 24px; background-color: #ff6b6b; color: white; border: none; border-radius: 12px; 
                        font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(255,107,107,0.3); display: none;">
                    ì˜¤ë‹µ í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div style="display: flex; flex: 1; overflow: hidden;">
    <!-- ì¢Œì¸¡: ê°€ë¡œì„¸ë¡œ ë³´ë“œ -->
        <div style="flex: 1.5; padding: 40px; display: flex; flex-direction: column; align-items: center; overflow-y: auto;">
            <div id="crosswordBoard" style="margin: 0 auto;"></div>
    </div>

    <!-- ìš°ì¸¡: ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ -->
        <div style="flex: 1; padding: 24px 36px; background-color: #fff8fc; overflow-y: auto; box-shadow: -3px 0 8px rgba(0,0,0,0.05);">
        <h2 style="color: #ff69b4; font-size: 20px; margin-bottom: 20px;">ğŸ“œ ë¬¸ì œ ëª©ë¡</h2>
        <div id="clueSection" style="width: 100%;"></div>
    </div>
    </div>
</div>

<script>
    let quizData = null; // í€´ì¦ˆ ë°ì´í„° ì €ì¥
    let currentDirection = 'across'; // í˜„ì¬ ë°©í–¥
    let currentPosition = null; // í˜„ì¬ ìœ„ì¹˜
    let quizResults = null; // í€´ì¦ˆ ê²°ê³¼ ì €ì¥
    
    window.onload = async function () {
        if (!window.userId) {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
            location.href = '/login';
            return;
        }

        const response = await fetch(`/api/quiz/crossword?userId=${window.userId}`);
        const quiz = await response.json();
        quizData = quiz; // í€´ì¦ˆ ë°ì´í„° ì €ì¥

        // ì‹¤ì œ ì‚¬ìš©ëœ ì˜ì—­ ê³„ì‚°
        let minRow = 999, maxRow = -1, minCol = 999, maxCol = -1;
        quiz.items.forEach(item => {
            let r = item.row, c = item.col;
            for (let i = 0; i < item.length; i++) {
                if (item.direction === "across") {
                    minRow = Math.min(minRow, r);
                    maxRow = Math.max(maxRow, r);
                    minCol = Math.min(minCol, c + i);
                    maxCol = Math.max(maxCol, c + i);
                } else {
                    minRow = Math.min(minRow, r + i);
                    maxRow = Math.max(maxRow, r + i);
                    minCol = Math.min(minCol, c);
                    maxCol = Math.max(maxCol, c);
                }
            }
        });

        // ì—¬ìœ  ê³µê°„ ì¶”ê°€ (ì¢Œìš° 1ì¹¸ì”©, í•˜ë‹¨ 1ì¹¸)
        minCol = Math.max(0, minCol - 1);
        maxCol += 1;
        maxRow += 1; // í•˜ë‹¨ ì—¬ìœ  ê³µê°„
        
        // ìµœìƒë‹¨ì— ì—¬ìœ  ê³µê°„ 1ì¹¸ì„ ì¶”ê°€í•˜ê¸° ìœ„í•´ minRowë¥¼ 0ìœ¼ë¡œ ì„¤ì •í•˜ì§€ ì•Šê³  ì¡°ì •
        const width = maxCol - minCol + 1;
        const height = maxRow - minRow + 2;  // +2: ìƒë‹¨ ì—¬ìœ  ê³µê°„ 1ì¹¸ + ì •ìƒ ê³„ì‚°ëœ ë†’ì´
        const board = Array.from({length: height}, () => Array(width).fill(null));

        // ë²ˆí˜¸ ë§¤í•‘ì„ ìœ„í•œ 2D ë°°ì—´ (ê°€ë¡œ, ì„¸ë¡œ ê°ê°)
        const acrossNumbers = Array.from({length: height}, () => Array(width).fill(null));
        const downNumbers = Array.from({length: height}, () => Array(width).fill(null));

        quiz.items.forEach(item => {
            let r = item.row, c = item.col;
            for (let i = 0; i < item.length; i++) {
                if (item.direction === "across") {
                    let adjRow = r - minRow + 1;  // +1ë¡œ ìµœìƒë‹¨ ì—¬ìœ  ê³µê°„ ì¶”ê°€
                    let adjCol = c + i - minCol;
                    board[adjRow][adjCol] = { term: item.term, idx: i, number: i === 0 ? item.number : null, itemIdx: quiz.items.indexOf(item), direction: "across", row: r, col: c + i };
                    if (i === 0) acrossNumbers[adjRow][adjCol] = item.number;
                } else {
                    let adjRow = r + i - minRow + 1;  // +1ë¡œ ìµœìƒë‹¨ ì—¬ìœ  ê³µê°„ ì¶”ê°€
                    let adjCol = c - minCol;
                    board[adjRow][adjCol] = { term: item.term, idx: i, number: i === 0 ? item.number : null, itemIdx: quiz.items.indexOf(item), direction: "down", row: r + i, col: c };
                    if (i === 0) downNumbers[adjRow][adjCol] = item.number;
                }
            }
        });
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì¡°ì • ê°’ ì €ì¥
        window.minRow = minRow;
        window.minCol = minCol;

        const boardDiv = document.getElementById("crosswordBoard");
        const table = document.createElement("table");
        table.style.borderCollapse = "collapse";
        table.style.margin = "0 auto";
        table.style.background = "#fffafc";
        table.style.boxShadow = "0 4px 16px rgba(0,0,0,0.08)";
        table.style.borderRadius = "20px";
        table.id = "crosswordTable";

        for (let r = 0; r < height; r++) {
            const tr = document.createElement("tr");
            for (let c = 0; c < width; c++) {
                const td = document.createElement("td");
                td.style.width = td.style.height = "36px";
                td.style.border = "1.5px solid #d0d0d0";
                td.style.background = board[r][c] ? "#fff" : "#f0f0f0";
                td.style.position = "relative";
                td.style.borderRadius = "8px";

                if (board[r][c]) {
                    td.className = "crossword-cell";
                    // ì›ë˜ ì¢Œí‘œ ì €ì¥ (ì¡°ì • ì „ ì¢Œí‘œ)
                    td.dataset.originalRow = board[r][c].row;
                    td.dataset.originalCol = board[r][c].col;
                    td.dataset.row = r;
                    td.dataset.col = c;

                    // ë²ˆí˜¸ í‘œì‹œ (ê°€ë¡œ/ì„¸ë¡œ ëª¨ë‘ í‘œì‹œ)
                    if (acrossNumbers[r][c] || downNumbers[r][c]) {
                        const numberDiv = document.createElement("div");
                        numberDiv.style.position = "absolute";
                        numberDiv.style.top = "2px";
                        numberDiv.style.left = "4px";
                        numberDiv.style.fontSize = "8px";
                        numberDiv.style.lineHeight = "1";

                        if (acrossNumbers[r][c] && downNumbers[r][c]) {
                            // ê²¹ì¹˜ëŠ” ê²½ìš°
                            numberDiv.innerHTML = `<span style="color:#4a90e2;">${acrossNumbers[r][c]}</span><br><span style="color:#ff69b4;">${downNumbers[r][c]}</span>`;
                        } else if (acrossNumbers[r][c]) {
                            // ê°€ë¡œë§Œ
                            numberDiv.innerHTML = `<span style="color:#4a90e2;">${acrossNumbers[r][c]}</span>`;
                        } else {
                            // ì„¸ë¡œë§Œ
                            numberDiv.innerHTML = `<span style="color:#ff69b4;">${downNumbers[r][c]}</span>`;
                        }

                        td.appendChild(numberDiv);
                    }

                    const input = document.createElement("input");
                    input.type = "text";
                    input.maxLength = 1;
                    input.style.width = "100%";
                    input.style.height = "100%";
                    input.style.textAlign = "center";
                    input.style.fontSize = "18px";
                    input.style.border = "none";
                    input.style.background = "transparent";
                    input.style.caretColor = board[r][c].direction === "across" ? "#4a90e2" : "#ff69b4";
                    input.style.borderRadius = "8px";
                    input.dataset.row = r;
                    input.dataset.col = c;
                    input.readOnly = false;
                    input.classList.add("crossword-input");
                    
                    // ì…ë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬ - í•œ ê¸€ìë§Œ ì…ë ¥ë˜ë„ë¡ ë³´ì¥
                    input.addEventListener('input', function(e) {
                        const value = e.target.value;
                        // í•œ ê¸€ìê°€ ì•„ë‹Œ ê²½ìš° ì²« ê¸€ìë§Œ ìœ ì§€
                        if (value.length > 1) {
                            e.target.value = value.charAt(0);
                        }
                    });
                    
                    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë°©í–¥í‚¤ ì´ë™)
                    input.addEventListener('keydown', function(e) {
                        handleKeyDown(e);
                    });
                    
                    // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ - í˜„ì¬ ë°©í–¥ ê²°ì •
                    input.addEventListener('focus', function(e) {
                        const r = parseInt(e.target.dataset.row);
                        const c = parseInt(e.target.dataset.col);
                        currentPosition = {row: r, col: c};
                        const cellData = board[r][c];
                        if (cellData) {
                            currentDirection = cellData.direction;
                        }
                    });
                    
                    td.appendChild(input);
                }

                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
        boardDiv.appendChild(table);

        // ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        const clueSection = document.getElementById("clueSection");
        clueSection.innerHTML = quiz.items.map((item, idx) => {
            const clueText = (item.clue || item.question).replace(/\n/g, "<br>");
            return `
            <div class="crossword-quiz-row" id="quizRow_${idx}"
                style="display: flex; align-items: center; margin-bottom: 16px; background: ${item.direction === 'across' ? '#e6f3ff' : '#fff0fa'};
                       border-radius: 16px; padding: 12px 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                <span style="font-weight:bold; color:${item.direction === 'across' ? '#4a90e2' : '#ff69b4'}; min-width:60px;">
                    ${item.number}. ${item.direction === 'across' ? 'ê°€ë¡œ' : 'ì„¸ë¡œ'}
                </span>
                <span style="margin-left:10px; flex:1; font-size:14px; color:#333;">${clueText}</span>
                <button id="hintBtn_${idx}" style="margin-left:6px; border:none; background:${item.direction === 'across' ? '#b3d9ff' : '#ffccdc'};
                        color:#333; border-radius:8px; padding:5px 8px; cursor: pointer;">ì´ˆì„± íŒíŠ¸</button>
                <span id="hintText_${idx}" style="display:none; margin-left:10px; color:#888;">${item.initialHint}</span>
                <span id="resultIcon_${idx}" style="margin-left:12px; font-size:22px;"></span>
            </div>
            `;
        }).join("");

        // íŒíŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        quiz.items.forEach((item, idx) => {
            document.getElementById(`hintBtn_${idx}`).onclick = function() {
                const hintText = document.getElementById(`hintText_${idx}`);
                hintText.style.display = hintText.style.display === "none" ? "inline" : "none";
            };
        });

        // ì „ì²´ ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById("submitAllBtn").onclick = async function() {
            if (!window.userId) {
                alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }

            const answers = collectAnswers();
            
            // ì´ì „ ë±ƒì§€ ì •ë³´ ì €ì¥
            let previousBadges = new Set();
            try {
                const prevBadgeRes = await fetch(`/api/users/${window.userId}/badges`);
                if (prevBadgeRes.ok) {
                    const prevBadges = await prevBadgeRes.json();
                    previousBadges = new Set(prevBadges.filter(b => b.earned).map(b => b.name));
                }
            } catch (e) {
                console.error('ì´ì „ ë±ƒì§€ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
            
            try {
                const response = await fetch('/api/quiz/submit-crossword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ answers: answers })
                });
                
                const result = await response.json();
                displayResults(result);
                
                // ì œì¶œ í›„ ì…ë ¥ ë¹„í™œì„±í™”
                document.querySelectorAll('.crossword-input').forEach(input => {
                    input.disabled = true;
                });
                
                document.getElementById("submitAllBtn").disabled = true;
                document.getElementById("submitAllBtn").textContent = "ì™„ë£Œ";
                document.getElementById("submitAllBtn").style.background = "#94a3b8";
                
                // ì˜¤ë‹µ í™•ì¸ ë²„íŠ¼ í‘œì‹œ
                document.getElementById("showAnswersBtn").style.display = "block";
                
                // í¬ì¸íŠ¸ ê°±ì‹  ë° íŒì—… í‘œì‹œ
                if (result && result.score > 0) {
                    try {
                        const pointsRes = await fetch(`/api/users/${window.userId}/points`);
                        if (pointsRes.ok) {
                            const pointsData = await pointsRes.json();
                            const earned = result.score || 0;
                            const latestTotal = result.totalPoints || (pointsData.totalPoints || 0) + earned;

                            // í¬ì¸íŠ¸ íšë“ íŒì—…
                            await showPointsNotification(earned, latestTotal);
                            
                            // ë±ƒì§€ ë³€ê²½ í™•ì¸
                            setTimeout(async () => {
                                await checkBadgeChanges(previousBadges);
                            }, 300);
                        }
                    } catch (error) {
                        console.error('í¬ì¸íŠ¸ ê°±ì‹  ì‹¤íŒ¨:', error);
                    }
                }
                
            } catch (error) {
                console.error('Error submitting crossword:', error);
                alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };
        
        // ì˜¤ë‹µ í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById("showAnswersBtn").onclick = function() {
            showWrongAnswers();
        };
    };

    // ë³´ë“œíŒì—ì„œ ë‹µì•ˆ ìˆ˜ì§‘
    function collectAnswers() {
        const answers = {};
        const table = document.getElementById('crosswordTable');
        if (!table) return answers;
        
        quizData.items.forEach((item, idx) => {
            let r = item.row, c = item.col;
            let userAnswer = '';
            
            for (let i = 0; i < item.length; i++) {
                let rr = item.direction === "across" ? r : r+i;
                let cc = item.direction === "across" ? c+i : c;
                // ì¡°ì •ëœ ì¢Œí‘œë¡œ ì°¾ê¸° (ìµœìƒë‹¨ ì—¬ìœ  ê³µê°„ 1ì¹¸ ì¶”ê°€)
                const adjR = rr - window.minRow + 1;
                const adjC = cc - window.minCol;
                const input = table.rows[adjR]?.cells[adjC]?.querySelector(".crossword-input");
                if (input) {
                    userAnswer += input.value || '';
                }
            }
            
            if (userAnswer.trim()) {
                answers[item.term] = userAnswer;
            }
        });
        
        return answers;
    }

    // ê²°ê³¼ í‘œì‹œ
    function displayResults(result) {
        quizResults = result.results || {}; // ê²°ê³¼ ì €ì¥
        const table = document.getElementById('crosswordTable');
        
        // ê° ì…€ì— ëŒ€í•œ ê²°ê³¼ ì •ë³´ ìˆ˜ì§‘
        const cellResults = {}; // key: "r,c", value: { acrossCorrect, downCorrect, acrossItem, downItem }
        
        quizData.items.forEach((item, idx) => {
            const isCorrect = quizResults[item.term] || false;
                let r = item.row, c = item.col;
            
                for (let i = 0; i < item.length; i++) {
                    let rr = item.direction === "across" ? r : r+i;
                    let cc = item.direction === "across" ? c+i : c;
                    const key = `${rr},${cc}`;
                
                if (!cellResults[key]) {
                    cellResults[key] = {};
                }
                
                if (item.direction === "across") {
                    cellResults[key].acrossCorrect = isCorrect;
                    cellResults[key].acrossItem = item;
                } else {
                    cellResults[key].downCorrect = isCorrect;
                    cellResults[key].downItem = item;
                }
            }
        });
        
        // ì…€ì— ìƒ‰ê¹” ì ìš© (ê°€ë¡œ ë¬¸ì œ ìš°ì„ ê¶Œ, ë§ì€ ë¬¸ì œë§Œ ìƒ‰ê¹” í‘œì‹œ)
        for (const [key, data] of Object.entries(cellResults)) {
            const [rr, cc] = key.split(',').map(Number);
            const adjR = rr - window.minRow + 1;  // ìµœìƒë‹¨ ì—¬ìœ  ê³µê°„ 1ì¹¸ ê³ ë ¤
            const adjC = cc - window.minCol;
            const input = table.rows[adjR]?.cells[adjC]?.querySelector(".crossword-input");

                    if (input) {
                // ê°€ë¡œ ë¬¸ì œ ìš°ì„ ê¶Œ ì ìš©
                let colorApplied = false;
                
                // 1. ê°€ë¡œ ë¬¸ì œê°€ ì •ë‹µì¸ ê²½ìš°
                if (data.acrossItem && data.acrossCorrect) {
                    input.style.background = "#f2f8ff";
                    input.style.color = "#000000";
                    colorApplied = true;
                }
                // 2. ê°€ë¡œ ë¬¸ì œê°€ ì •ë‹µì´ ì•„ë‹ˆê³  ì„¸ë¡œ ë¬¸ì œê°€ ì •ë‹µì¸ ê²½ìš°
                else if (data.downItem && data.downCorrect && (!data.acrossItem || !data.acrossCorrect)) {
                    input.style.background = "#fff6fb";
                            input.style.color = "#000000";
                    colorApplied = true;
                }
                // 3. ë‘˜ ë‹¤ ì˜¤ë‹µì¸ ê²½ìš°
                if (!colorApplied) {
                                input.style.background = "#ffe0e0";
                                input.style.color = "#ff4d4f";
                            }
                
                            input.style.fontWeight = "bold";
                        }
        }
        
        // ë¬¸ì œ ëª©ë¡ì— ê²°ê³¼ í‘œì‹œ
        quizData.items.forEach((item, idx) => {
            const isCorrect = quizResults[item.term] || false;
            const quizRow = document.getElementById(`quizRow_${idx}`);
            const icon = document.getElementById(`resultIcon_${idx}`);
            if (quizRow && icon) {
                quizRow.style.border = isCorrect 
                    ? (item.direction === "across" ? "2px solid #4a90e2" : "2px solid #ff69b4") 
                    : "2px solid #ff4d4f";
                icon.innerHTML = isCorrect 
                    ? `<span style="color:${item.direction === "across" ? "#4a90e2" : "#ff69b4"};">âœ”</span>` 
                    : '<span style="color:#ff4d4f;">âœ–</span>';
            }
        });
    }
    
    // í‹€ë¦° ë¬¸ì œ ì •ë‹µ í‘œì‹œ
    function showWrongAnswers() {
        const table = document.getElementById('crosswordTable');
        
        // ì˜¤ë‹µ ë¬¸ì œ ì¶”ì¶œ
        const wrongItems = quizData.items.filter(item => !quizResults[item.term]);
        
        // í‹€ë¦° ë¬¸ì œì— ëŒ€í•´ ìƒ‰ê¹” ìš°ì„ ê¶Œ ì ìš©
        wrongItems.forEach(item => {
    let r = item.row, c = item.col;
            
    for (let i = 0; i < item.length; i++) {
        let rr = item.direction === "across" ? r : r+i;
        let cc = item.direction === "across" ? c+i : c;
                // ì¡°ì •ëœ ì¢Œí‘œë¡œ ì°¾ê¸° (ìµœìƒë‹¨ ì—¬ìœ  ê³µê°„ 1ì¹¸ ì¶”ê°€)
                const adjR = rr - window.minRow + 1;
                const adjC = cc - window.minCol;
                const input = table.rows[adjR]?.cells[adjC]?.querySelector(".crossword-input");
                
        if (input) {
                    // ì •ë‹µì„ ë¹¨ê°„ ê¸€ì”¨ë¡œ í‘œì‹œ
            input.value = item.term[i];
                    input.style.background = "#ffe0e0";
                    input.style.color = "#dc2626"; // ì§„í•œ ë¹¨ê°•
            input.style.fontWeight = "bold";
                }
            }
        });
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        document.getElementById("showAnswersBtn").disabled = true;
        document.getElementById("showAnswersBtn").textContent = "ì˜¤ë‹µ í™•ì¸ ì™„ë£Œ";
        document.getElementById("showAnswersBtn").style.background = "#94a3b8";
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ - ë°©í–¥í‚¤ë¡œ ì…€ ì´ë™ë§Œ í—ˆìš©
    function handleKeyDown(e) {
        const r = parseInt(e.target.dataset.row);
        const c = parseInt(e.target.dataset.col);
        let nextInput = null;
        
        switch(e.key) {
            case 'ArrowRight':
                e.preventDefault();
                nextInput = document.querySelector(`.crossword-input[data-row="${r}"][data-col="${c+1}"]`);
                if (nextInput && !nextInput.disabled) {
                    nextInput.focus();
                }
                break;
            case 'ArrowLeft':
                e.preventDefault();
                nextInput = document.querySelector(`.crossword-input[data-row="${r}"][data-col="${c-1}"]`);
                if (nextInput && !nextInput.disabled) {
                    nextInput.focus();
                }
                break;
            case 'ArrowDown':
                e.preventDefault();
                nextInput = document.querySelector(`.crossword-input[data-row="${r+1}"][data-col="${c}"]`);
                if (nextInput && !nextInput.disabled) {
                    nextInput.focus();
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                nextInput = document.querySelector(`.crossword-input[data-row="${r-1}"][data-col="${c}"]`);
                if (nextInput && !nextInput.disabled) {
                    nextInput.focus();
                }
                break;
        }
    }
    
    // í¬ì¸íŠ¸ íšë“ íŒì—…
    async function showPointsNotification(earnedPoints, totalPoints) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
            min-width: 280px;
        `;
        
        // ë‹¤ìŒ ë‹¨ê³„ ì •ë³´ ë° í˜„ì¬ ë±ƒì§€ ê°€ì ¸ì˜¤ê¸°
        let nextStage = '';
        let progressPercent = 0;
        let currentBadge = null;
        try {
            const badgeRes = await fetch(`/api/users/${window.userId}/badges`);
            if (badgeRes.ok) {
                const badges = await badgeRes.json();
                const earnedBadges = badges.filter(b => b.earned);
                
                // í˜„ì¬ ë“±ê¸‰ ì°¾ê¸°
                const rankOrder = ['ë¸Œë¡ ì¦ˆ','ì‹¤ë²„','ê³¨ë“œ','í”Œë˜í‹°ë„˜'];
                currentBadge = earnedBadges
                    .filter(b => rankOrder.includes(b.name))
                    .sort((a,b) => rankOrder.indexOf(b.name) - rankOrder.indexOf(a.name))[0];
                
                const next = badges.filter(b => !b.earned).sort((a,b)=>a.conditionValue-b.conditionValue)[0];
                if (next) {
                    nextStage = next.name;
                    progressPercent = Math.min(100, (totalPoints / next.conditionValue) * 100);
                }
            }
        } catch (e) {
            console.error('ë±ƒì§€ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
        
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 18px;">ğŸ‰ í¬ì¸íŠ¸ íšë“!</div>
            ${currentBadge ? `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <img src="${currentBadge.imageUrl}" alt="${currentBadge.name}" style="width: 240px; height: 240px; object-fit: contain;">
                    <div style="text-align: center;">
                        <div style="font-size: 13px; opacity: 0.9;">í˜„ì¬ ë“±ê¸‰</div>
                        <div style="font-weight: bold; font-size: 16px;">${currentBadge.name}</div>
                    </div>
                </div>
            ` : ''}
            <div style="margin-bottom: 6px; font-size: 16px;">+${earnedPoints}ì  íšë“</div>
            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">ì´ ${totalPoints}ì </div>
            ${nextStage ? `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 12px; margin-bottom: 6px;">ë‹¤ìŒ ë‹¨ê³„: ${nextStage}</div>
                    <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${progressPercent}%; background: white; border-radius: 4px; transition: width 0.8s ease;"></div>
                    </div>
                </div>
            ` : ''}
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.5s ease-in';
            setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 500);
        }, 4000);
    }
    
    // ë±ƒì§€ ë³€ê²½ í™•ì¸ ë° íŒì—…
    async function checkBadgeChanges(previousBadges) {
        try {
            const badgeRes = await fetch(`/api/users/${window.userId}/badges`);
            if (!badgeRes.ok) return;
            
            const badges = await badgeRes.json();
            const currentBadgesSet = new Set(badges.filter(b => b.earned).map(b => b.name));
            const newlyEarnedNames = [...currentBadgesSet].filter(b => !previousBadges.has(b));
            
            if (newlyEarnedNames.length > 0) {
                // ë±ƒì§€ ì „ì²´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const newlyEarnedBadges = badges.filter(b => b.earned && newlyEarnedNames.includes(b.name));
                showBadgeNotification(newlyEarnedBadges);
            }
        } catch (error) {
            console.error('ë±ƒì§€ í™•ì¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // ë±ƒì§€ íšë“ íŒì—…
    function showBadgeNotification(badges) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff8a00, #e52e71);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1001;
            animation: badgeSlideIn 0.5s ease-out;
            max-width: 350px;
            text-align: center;
        `;
        
        const list = badges.map(badge => {
            return `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <img src="${badge.imageUrl}" alt="${badge.name}" style="width: 50px; height: 50px; object-fit: contain;">
                    <div style="text-align: left;">
                        <div style="font-weight: bold; font-size: 16px;">${badge.name}</div>
                        <div style="font-size: 11px; opacity: 0.9;">ìƒˆë¡œ íšë“í•œ ë±ƒì§€</div>
                    </div>
                </div>
            `;
        }).join('');
        
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 12px; font-size: 18px;">ìƒˆ ë±ƒì§€ íšë“!</div>
            <div style="font-size: 14px; line-height: 1.4;">${list}</div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'badgeSlideOut 0.5s ease-in';
            setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 500);
        }, 4000);
    }
    
    // CSS ì• ë‹ˆë©”ì´ì…˜
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            to { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }
        @keyframes badgeSlideIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes badgeSlideOut {
            from { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            to { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>