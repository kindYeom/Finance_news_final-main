<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ - ì›Œë“œí´ë¼ìš°ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: linear-gradient(135deg, #e0e7ef 0%, #f5f7fa 100%);
            font-family: 'Noto Sans KR', sans-serif;
            color: #223a5e;
        }
        .container {
            max-width: 1100px;
            margin: 48px auto 0 auto;
            background: #fff;
            border-radius: 22px;
            box-shadow: 0 8px 32px #223a5e18;
            padding: 40px 36px 36px 36px;
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }
        .cloud-section {
            flex: 2;
            min-width: 400px;
        }
        .side-section {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }
        .section-title {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #003675;
        }
        .desc {
            color: #4b5c7a;
            margin-bottom: 18px;
            font-size: 1.08em;
        }
        #keyword-cloud {
            width: 100%;
            height: 420px;
            min-height: 320px;
            background: #f5f7fa;
            border-radius: 18px;
            box-shadow: 0 2px 12px #223a5e0a;
        }
        .stat-box {
            background: #f4f8ff;
            border-radius: 12px;
            padding: 18px 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px #223a5e11;
        }
        .stat-title {
            font-size: 1.1em;
            color: #2563eb;
            font-weight: 600;
        }
        .stat-value {
            font-size: 1.7em;
            font-weight: 700;
            color: #003675;
        }
        .top-keywords {
            background: #f8fafc;
            border-radius: 12px;
            padding: 18px 20px;
            box-shadow: 0 2px 8px #223a5e11;
        }
        .top-keywords-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2563eb;
        }
        .top-keywords-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .top-keywords-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e3e8f0;
            font-size: 1.08em;
            transition: background 0.13s;
        }
        .top-keywords-list li:last-child {
            border-bottom: none;
        }
        .top-keywords-list li:hover {
            background: #eaf2ff;
        }
        .kw-link {
            cursor: pointer;
            color: #2563eb;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .kw-link:hover {
            color: #1d4ed8;
            text-decoration: underline;
            background-color: #eaf2ff;
        }
        .kw-link:active {
            transform: scale(0.98);
        }
        .trend-up { color: #1db954; font-size: 1.1em; margin-left: 6px; }
        .trend-down { color: #e74c3c; font-size: 1.1em; margin-left: 6px; }
        .search-box {
            margin-bottom: 10px;
        }
        .search-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #e3e8f0;
            font-size: 1em;
            margin-bottom: 4px;
        }
        .modal-bg {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25); z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #fff; border-radius: 16px; padding: 32px 36px 24px 36px; min-width: 320px; max-width: 90vw; max-height: 80vh;
            box-shadow: 0 8px 32px #223a5e22; position: relative; overflow-y: auto;
        }
        .modal-close {
            position: absolute; top: 18px; right: 24px; border: none; background: none; font-size: 1.5em; color: #aaa; cursor: pointer;
        }
        .modal-close:hover { color: #003675; }
        
        /* ë‰´ìŠ¤ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .news-list {
            margin-top: 20px;
        }
        .news-item {
            border: 1px solid #e3e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #f8fafc;
            transition: all 0.2s ease;
        }
        .news-item:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }
        .news-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .news-content {
            color: #64748b;
            font-size: 0.95em;
            line-height: 1.5;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #94a3b8;
        }
        .news-publisher {
            font-weight: 500;
            color: #2563eb;
        }
        .news-date {
            color: #64748b;
        }
        .news-link {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
        }
        .news-link:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }
        .no-news {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e3e8f0;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination button:hover {
            background: #f1f5f9;
            border-color: #2563eb;
        }
        .pagination button.active {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 900px) {
            .container { flex-direction: column; gap: 24px; padding: 18px 6vw; }
            .cloud-section, .side-section { min-width: 0; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="cloud-section">
        <div class="section-title">ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ</div>
        <div class="desc">ìµœê·¼ ë‰´ìŠ¤ì—ì„œ ë§ì´ ë“±ì¥í•œ í‚¤ì›Œë“œë¥¼ ì›Œë“œí´ë¼ìš°ë“œë¡œ ì‹œê°í™”í•©ë‹ˆë‹¤.<br>í‚¤ì›Œë“œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë‰´ìŠ¤ ê¸°ì‚¬ë“¤ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <div id="keyword-cloud"></div>
    </div>
    <div class="side-section">
        <div class="stat-box">
            <div class="stat-title">ì „ì²´ í‚¤ì›Œë“œ ìˆ˜</div>
            <div class="stat-value" id="total-keywords">-</div>
        </div>
        <div class="stat-box">
            <div class="stat-title">ì˜¤ëŠ˜ì˜ ì´ í‚¤ì›Œë“œ ë¹ˆë„</div>
            <div class="stat-value" id="total-frequency">-</div>
        </div>
        <div class="search-box">
            <input type="text" class="search-input" id="keywordSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰...">
        </div>
        <div class="top-keywords">
            <div class="top-keywords-title">ì¸ê¸° í‚¤ì›Œë“œ TOP 10</div>
            <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;">í‚¤ì›Œë“œë¥¼ í´ë¦­í•˜ë©´ ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            <ul class="top-keywords-list" id="topKeywordsList"></ul>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2/dist/echarts-wordcloud.min.js"></script>
<script>
(function() {
    const chartDom = document.getElementById('keyword-cloud');
    const myChart = echarts.init(chartDom);
    let allKeywords = [];
    let trends = {}; // ì¶”í›„ íŠ¸ë Œë“œ ë°ì´í„° ì—°ë™ ê°€ëŠ¥
    let totalFrequency = 0;

    function renderWordCloud(data) {
        myChart.setOption({
            tooltip: {
                show: true,
                formatter: function(params) {
                    return params.name + ': ' + params.value + 'íšŒ';
                }
            },
            series: [{
                type: 'wordCloud',
                shape: 'circle',
                left: 'center',
                top: 'center',
                width: '100%',
                height: '100%',
                sizeRange: [18, 80],
                rotationRange: [0, 0],
                gridSize: 8,
                drawOutOfBound: false,
                textStyle: {
                    color: function() {
                        // ë‹¤ì–‘í•œ íŒŒìŠ¤í…” ê³„ì—´ ìƒ‰ìƒ
                        const colors = ['#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE', '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    }
                },
                data: data
            }]
        });
    }

    function renderTopKeywords(data) {
        const topList = document.getElementById('topKeywordsList');
        topList.innerHTML = '';
        data.slice(0, 10).forEach((item, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `<span><b>${idx+1}.</b> <span class="kw-link">${item.name}</span></span> <span>${item.value}íšŒ</span>`;
            
            // í‚¤ì›Œë“œ ë§í¬ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            const keywordLink = li.querySelector('.kw-link');
            if (keywordLink) {
                keywordLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    showKeywordNews(item.name);
                });
            }
            
            topList.appendChild(li);
        });
    }

    function updateStats(data) {
        document.getElementById('total-keywords').textContent = data.length;
        document.getElementById('total-frequency').textContent = totalFrequency;
    }

    function showKeywordNews(keyword, page = 0) {
        const modalBg = document.createElement('div');
        modalBg.className = 'modal-bg';
        const modalBox = document.createElement('div');
        modalBox.className = 'modal-box';
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        modalBox.innerHTML = `
            <button class="modal-close" onclick="document.body.removeChild(this.parentNode.parentNode)">&times;</button>
            <h3>ğŸ“° "${keyword}" ê´€ë ¨ ë‰´ìŠ¤</h3>
            <div class="loading">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        `;
        
        modalBg.appendChild(modalBox);
        document.body.appendChild(modalBg);

        // ë‰´ìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetch(`/api/news?keyword=${encodeURIComponent(keyword)}&page=${page}&size=5`)
            .then(res => res.json())
            .then(data => {
                let newsHtml = '';
                
                if (data.content && data.content.length > 0) {
                    newsHtml = '<div class="news-list">';
                    data.content.forEach(news => {
                        const date = new Date(news.publishedAt).toLocaleDateString('ko-KR');
                        const content = news.content ? news.content.substring(0, 100) + '...' : '';
                        
                        newsHtml += `
                            <div class="news-item">
                                <div class="news-title">${news.title}</div>
                                <div class="news-content">${content}</div>
                                <div class="news-meta">
                                    <span class="news-publisher">${news.press || 'ë¯¸ìƒ'}</span>
                                    <span class="news-date">${date}</span>
                                </div>
                                ${news.url ? `<a href="${news.url}" target="_blank" class="news-link">ê¸°ì‚¬ ë³´ê¸° â†’</a>` : ''}
                            </div>
                        `;
                    });
                    newsHtml += '</div>';
                    
                    // í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€
                    if (data.totalPages > 1) {
                        newsHtml += '<div class="pagination">';
                        if (data.first) {
                            newsHtml += '<button disabled>ì´ì „</button>';
                        } else {
                            newsHtml += `<button onclick="showKeywordNews('${keyword}', ${page - 1})">ì´ì „</button>`;
                        }
                        
                        for (let i = 0; i < data.totalPages; i++) {
                            if (i === page) {
                                newsHtml += `<button class="active">${i + 1}</button>`;
                            } else {
                                newsHtml += `<button onclick="showKeywordNews('${keyword}', ${i})">${i + 1}</button>`;
                            }
                        }
                        
                        if (data.last) {
                            newsHtml += '<button disabled>ë‹¤ìŒ</button>';
                        } else {
                            newsHtml += `<button onclick="showKeywordNews('${keyword}', ${page + 1})">ë‹¤ìŒ</button>`;
                        }
                        newsHtml += '</div>';
                    }
                } else {
                    newsHtml = '<div class="no-news">í•´ë‹¹ í‚¤ì›Œë“œì™€ ê´€ë ¨ëœ ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                
                modalBox.innerHTML = `
                    <button class="modal-close" onclick="document.body.removeChild(this.parentNode.parentNode)">&times;</button>
                    <h3>ğŸ“° "${keyword}" ê´€ë ¨ ë‰´ìŠ¤</h3>
                    ${newsHtml}
                `;
            })
            .catch(error => {
                modalBox.innerHTML = `
                    <button class="modal-close" onclick="document.body.removeChild(this.parentNode.parentNode)">&times;</button>
                    <h3>ğŸ“° "${keyword}" ê´€ë ¨ ë‰´ìŠ¤</h3>
                    <div class="no-news">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
                `;
            });
    }

    function showModal(html) {
        const modalBg = document.createElement('div');
        modalBg.className = 'modal-bg';
        const modalBox = document.createElement('div');
        modalBox.className = 'modal-box';
        modalBox.innerHTML = `<button class="modal-close" onclick="document.body.removeChild(this.parentNode.parentNode)">&times;</button>${html}`;
        modalBg.appendChild(modalBox);
        document.body.appendChild(modalBg);
    }

    // ì›Œë“œí´ë¼ìš°ë“œ í´ë¦­ ì‹œ ë‰´ìŠ¤ ë³´ê¸°
    myChart.on('click', function(params) {
        showKeywordNews(params.name);
    });

    // í‚¤ì›Œë“œ ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById('keywordSearch').addEventListener('input', function() {
        const val = this.value.trim().toLowerCase();
        if (!val) {
            renderWordCloud(allKeywords);
            renderTopKeywords(allKeywords);
            return;
        }
        const filtered = allKeywords.filter(k => k.name.toLowerCase().includes(val));
        renderWordCloud(filtered);
        renderTopKeywords(filtered);
    });

    fetch('/api/keyword-frequency')
        .then(res => {
            if (!res.ok) {
                throw new Error('í‚¤ì›Œë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            return res.json();
        })
        .then(json => {
            if (json.data && Array.isArray(json.data)) {
                allKeywords = json.data.map(k => ({ name: k.name, value: k.value }));
                totalFrequency = allKeywords.reduce((sum, k) => sum + k.value, 0);
                renderWordCloud(allKeywords);
                renderTopKeywords(allKeywords);
                updateStats(allKeywords);
            } else {
                console.error('í‚¤ì›Œë“œ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', json);
                showModal('<h3>âš ï¸ ì˜¤ë¥˜</h3><div>í‚¤ì›Œë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>');
            }
        })
        .catch(error => {
            console.error('í‚¤ì›Œë“œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            showModal('<h3>âš ï¸ ì˜¤ë¥˜</h3><div>í‚¤ì›Œë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>');
        });
    window.addEventListener('resize', function() {
        myChart.resize();
    });
})();
</script>
</body>
</html> 