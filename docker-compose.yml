services:
  db:
    image: mysql:8.0
    container_name: mysql-db
    command:
      [
        "--default-authentication-plugin=mysql_native_password",
        "--character-set-server=utf8mb4",
        "--collation-server=utf8mb4_general_ci",
      ]
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: finance_news
      #MYSQL_USER: appuser
      #MYSQL_PASSWORD: apppass
      TZ: Asia/Seoul
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql
      # 초기 스키마/데이터가 있다면 아래 경로에 .sql 넣기
      # - ./mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mysqladmin ping -h localhost -uroot -p1234 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: spring-backend
    depends_on:
      db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/finance_news?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=UTF-8&serverTimezone=Asia/Seoul
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 1234
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      PYTHON_API_URL: http://crawler:8000
      FASTAPI_SERVER_URL: http://crawler:8000
      TZ: Asia/Seoul
    ports:
      - "8080:8080"
    # 소스 코드 핫리로드가 꼭 필요하면(개발중):
    # volumes:
    #   - ./backend:/workspace

  crawler:
    build:
      context: ./crawling
      dockerfile: Dockerfile
    container_name: py-crawler
    depends_on:
      db:
        condition: service_started
      backend:
        condition: service_started
    environment:
      TZ: Asia/Seoul
      # 필요시 MySQL 연결정보를 여기에도 넘길 수 있습니다 (crawling.py에서 사용 시)
      # DB_URL: mysql://appuser:apppass@db:3306/appdb
    # crawling.py 외 다른 명령을 테스트하고 싶다면 아래처럼 override 가능
    # command: ["python", "crawling.py", "--once"]
    # 크롤링 결과 파일을 호스트로 꺼내고 싶으면 볼륨 추가
    # volumes:
    #   - ./crawler/output:/app/output

volumes:
  db_data:
